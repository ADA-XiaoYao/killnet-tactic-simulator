version: '3.8'

services:
  attacker:
    build: ./lab-environment/attacker
    container_name: attacker
    tty: true
    stdin_open: true
    volumes:
      - ./attack-scripts:/scripts
    networks:
      lab_net:
        ipv4_address: 172.20.0.10

  # --- TARGET BLOCK START (UPDATED) ---
  target:
    build: ./lab-environment/target
    container_name: target
    # 我们将靶机的80端口也映射出来，方便在主机浏览器直接访问
    ports:
      - "8080:80"
    networks:
      lab_net:
        ipv4_address: 172.20.0.30

  # 新增：Nginx 指标导出器
  # 这个容器会连接到 target 服务的 /nginx_status 页面，
  # 并将数据转换为 Prometheus 可以理解的格式。
  target-exporter:
    image: nginx/nginx-prometheus-exporter:0.10.0
    container_name: target-exporter
    # 依赖于 target 服务先启动
    depends_on:
      - target
    # 启动命令，告诉 exporter 去哪里找 Nginx 的状态页面
    command: -nginx.scrape-uri http://target/nginx_status
    networks:
      lab_net:
        # 分配一个固定的IP
        ipv4_address: 172.20.0.31
  # --- TARGET BLOCK END (UPDATED) ---

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./lab-environment/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      lab_net:
        ipv4_address: 172.20.0.40

  grafana:
    build: ./lab-environment/monitoring/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    networks:
      lab_net:
        ipv4_address: 172.20.0.50

networks:
  lab_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
